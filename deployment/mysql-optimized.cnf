# MySQL 8.0 Optimized Configuration
# For: Laravel Delivery Dispatch (GPS Tracking Application)
# Server: Hetzner CPX31 (4 vCPU, 8GB RAM, 160GB NVMe SSD)
# Location: /etc/mysql/mysql.conf.d/99-delivery-dispatch.cnf
#
# Optimized for:
# - High write load (1.7M GPS location writes/day)
# - Spatial queries (POINT geometry, ST_GeomFromText)
# - Daily cleanup of rider_locations table
# - 60 riders, 1000 orders/day

[mysqld]

# Basic Settings
user = mysql
port = 3306
bind-address = 127.0.0.1
socket = /var/run/mysqld/mysqld.sock
pid-file = /var/run/mysqld/mysqld.pid
datadir = /var/lib/mysql

# Character Set
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# InnoDB Settings (optimized for 8GB RAM server)
# Using ~70% of RAM for MySQL (5.6GB), rest for OS and other services

# Buffer Pool - Critical for performance
# Set to 50-60% of total RAM for dedicated DB, 30-40% for shared server
innodb_buffer_pool_size = 3G
innodb_buffer_pool_instances = 3

# Log Files - Important for write-heavy workload
innodb_log_file_size = 512M
innodb_log_buffer_size = 64M
innodb_flush_log_at_trx_commit = 2  # Better performance, acceptable durability
innodb_flush_method = O_DIRECT

# Thread and Connection Settings
max_connections = 150
thread_cache_size = 50
table_open_cache = 4000
table_definition_cache = 2000

# Query Cache (disabled in MySQL 8.0, but keeping for reference)
# MySQL 8.0 removed query cache, using InnoDB buffer pool instead

# Temporary Tables
tmp_table_size = 64M
max_heap_table_size = 64M

# MyISAM Settings (minimal, as we use InnoDB)
key_buffer_size = 32M

# Write Performance Tuning
# Critical for GPS location inserts
innodb_write_io_threads = 8
innodb_read_io_threads = 4
innodb_io_capacity = 2000  # For SSD
innodb_io_capacity_max = 4000

# Disable double write buffer on modern filesystems (optional, use with caution)
# innodb_doublewrite = 0  # Uncomment only if using ZFS or similar with checksums

# Binary Logging (for backups and replication)
# Enable for point-in-time recovery
log_bin = /var/log/mysql/mysql-bin.log
binlog_expire_logs_seconds = 604800  # 7 days
max_binlog_size = 100M
binlog_format = ROW

# Slow Query Log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2  # Log queries taking more than 2 seconds

# General Log (disable in production for performance)
general_log = 0

# Error Log
log_error = /var/log/mysql/error.log

# Performance Schema (useful for monitoring, but uses memory)
performance_schema = ON
performance_schema_max_table_instances = 12500

# Spatial/Geometry Settings
# These are defaults but explicitly set for clarity
innodb_strict_mode = 1

# Sort and Join Buffer
sort_buffer_size = 2M
read_buffer_size = 1M
read_rnd_buffer_size = 2M
join_buffer_size = 2M

# Concurrent Inserts (for MyISAM, but good to set)
concurrent_insert = 2

# Wait Timeout
wait_timeout = 600
interactive_timeout = 600

# Max Allowed Packet
max_allowed_packet = 64M

# Adaptive Hash Index (for frequently accessed data)
innodb_adaptive_hash_index = ON

# Change Buffering (optimize for INSERT operations)
innodb_change_buffering = all

# File Per Table (recommended)
innodb_file_per_table = 1

# Transaction Isolation
transaction_isolation = READ-COMMITTED

# Undo Log Settings
innodb_undo_log_truncate = ON
innodb_max_undo_log_size = 1G

# Optimizer Settings
optimizer_switch = 'batched_key_access=on,block_nested_loop=on,mrr=on,mrr_cost_based=off'

# Group Replication (disabled, but available for future HA setup)
# disabled_storage_engines = "MyISAM,BLACKHOLE,FEDERATED,ARCHIVE,MEMORY"

[mysql]
default-character-set = utf8mb4

[client]
default-character-set = utf8mb4
port = 3306
socket = /var/run/mysqld/mysqld.sock

[mysqldump]
quick
quote-names
max_allowed_packet = 64M
default-character-set = utf8mb4
