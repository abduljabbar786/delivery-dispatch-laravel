# Supervisor Configuration for Laravel Delivery Dispatch
# Location: /etc/supervisor/conf.d/delivery-dispatch.conf
#
# After copying this file, run:
# sudo supervisorctl reread
# sudo supervisorctl update
# sudo supervisorctl start all

# Laravel Queue Workers
# Multiple workers for handling broadcast jobs efficiently
[program:delivery-dispatch-queue-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/delivery-dispatch/artisan queue:work redis --sleep=3 --tries=3 --max-time=3600 --timeout=300
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=deploy
numprocs=3
redirect_stderr=true
stdout_logfile=/var/log/delivery-dispatch/queue-worker.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=3600

# Laravel Reverb WebSocket Server
[program:delivery-dispatch-reverb]
process_name=%(program_name)s
command=php /var/www/delivery-dispatch/artisan reverb:start --host=127.0.0.1 --port=8080
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=deploy
redirect_stderr=true
stdout_logfile=/var/log/delivery-dispatch/reverb.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stopwaitsecs=10

# Laravel Schedule Runner
# Runs every minute to execute scheduled tasks (including cleanup commands)
[program:delivery-dispatch-scheduler]
process_name=%(program_name)s
command=/bin/bash -c "while true; do php /var/www/delivery-dispatch/artisan schedule:run --verbose --no-interaction; sleep 60; done"
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
user=deploy
redirect_stderr=true
stdout_logfile=/var/log/delivery-dispatch/scheduler.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10

# Group configuration for easier management
[group:delivery-dispatch]
programs=delivery-dispatch-queue-worker,delivery-dispatch-reverb,delivery-dispatch-scheduler
priority=999
